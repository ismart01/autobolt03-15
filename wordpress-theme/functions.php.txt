<?php
// Tema Autobolt - Functions.php

// Suporte a recursos do tema
function autobolt_theme_setup() {
    // Suporte a título dinâmico
    add_theme_support('title-tag');
    
    // Suporte a imagens destacadas
    add_theme_support('post-thumbnails');
    
    // Suporte a menus
    add_theme_support('menus');
    
    // Suporte a HTML5
    add_theme_support('html5', array(
        'search-form',
        'comment-form',
        'comment-list',
        'gallery',
        'caption',
    ));
    
    // Suporte a formatos de post
    add_theme_support('post-formats', array(
        'aside',
        'gallery',
        'link',
        'image',
        'quote',
        'status',
        'video',
        'audio',
        'chat'
    ));
}
add_action('after_setup_theme', 'autobolt_theme_setup');

// Enfileirar estilos e scripts
function autobolt_scripts() {
    // CSS principal
    wp_enqueue_style('autobolt-style', get_stylesheet_uri(), array(), '1.0.0');
    
    // Google Fonts (opcional)
    wp_enqueue_style('autobolt-fonts', 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap', array(), null);
    
    // Scripts customizados
    wp_enqueue_script('autobolt-main', get_template_directory_uri() . '/js/main.js', array('jquery'), '1.0.0', true);
    
    // Localizar script para AJAX (se necessário)
    wp_localize_script('autobolt-main', 'autobolt_ajax', array(
        'ajax_url' => admin_url('ajax.php'),
        'nonce' => wp_create_nonce('autobolt_nonce')
    ));
}
add_action('wp_enqueue_scripts', 'autobolt_scripts');

// Registrar menus
function autobolt_menus() {
    register_nav_menus(array(
        'primary' => 'Menu Principal',
        'footer' => 'Menu Footer'
    ));
}
add_action('init', 'autobolt_menus');

// Registrar sidebars/widgets
function autobolt_widgets_init() {
    register_sidebar(array(
        'name' => 'Sidebar Principal',
        'id' => 'sidebar-1',
        'description' => 'Widgets da sidebar principal',
        'before_widget' => '<div id="%1$s" class="widget %2$s">',
        'after_widget' => '</div>',
        'before_title' => '<h3 class="widget-title">',
        'after_title' => '</h3>',
    ));
    
    register_sidebar(array(
        'name' => 'Footer',
        'id' => 'footer-1',
        'description' => 'Widgets do footer',
        'before_widget' => '<div id="%1$s" class="footer-widget %2$s">',
        'after_widget' => '</div>',
        'before_title' => '<h4 class="footer-widget-title">',
        'after_title' => '</h4>',
    ));
}
add_action('widgets_init', 'autobolt_widgets_init');

// Customizar excerpt
function autobolt_custom_excerpt_length($length) {
    return 20;
}
add_filter('excerpt_length', 'autobolt_custom_excerpt_length', 999);

function autobolt_custom_excerpt_more($more) {
    return '...';
}
add_filter('excerpt_more', 'autobolt_custom_excerpt_more');

// Remover versão do WordPress por segurança
function autobolt_remove_version() {
    return '';
}
add_filter('the_generator', 'autobolt_remove_version');

// Desabilitar XML-RPC por segurança
add_filter('xmlrpc_enabled', '__return_false');

// Remover links desnecessários do head
remove_action('wp_head', 'wp_generator');
remove_action('wp_head', 'wlwmanifest_link');
remove_action('wp_head', 'rsd_link');

// Função para adicionar classes CSS personalizadas ao body
function autobolt_body_classes($classes) {
    // Adicionar classe se for página inicial
    if (is_front_page()) {
        $classes[] = 'home-page';
    }
    
    // Adicionar classe para mobile (pode ser útil)
    if (wp_is_mobile()) {
        $classes[] = 'mobile-device';
    }
    
    return $classes;
}
add_filter('body_class', 'autobolt_body_classes');

// Função para otimizar imagens (básico)
function autobolt_image_sizes() {
    // Tamanhos personalizados de imagem
    add_image_size('autobolt-hero', 800, 600, true);
    add_image_size('autobolt-card', 400, 300, true);
    add_image_size('autobolt-testimonial', 100, 100, true);
}
add_action('after_setup_theme', 'autobolt_image_sizes');

// Shortcode para botão WhatsApp
function autobolt_whatsapp_button($atts) {
    $atts = shortcode_atts(array(
        'numero' => '5511999999999',
        'texto' => 'Quero conhecer o Autobolt',
        'classe' => 'cta-button'
    ), $atts);
    
    $link = 'https://wa.me/' . $atts['numero'] . '?text=' . urlencode($atts['texto']);
    
    return '<a href="' . $link . '" class="' . $atts['classe'] . '" target="_blank">QUERO AGORA!</a>';
}
add_shortcode('whatsapp_button', 'autobolt_whatsapp_button');

// Função para adicionar meta tags dinâmicas
function autobolt_meta_tags() {
    if (is_single() || is_page()) {
        global $post;
        
        // Descrição da página/post
        if ($post->post_excerpt) {
            echo '<meta name="description" content="' . esc_attr(strip_tags($post->post_excerpt)) . '">' . "\n";
        } else {
            $content = strip_tags($post->post_content);
            $description = substr($content, 0, 160);
            echo '<meta name="description" content="' . esc_attr($description) . '...">' . "\n";
        }
        
        // Open Graph para posts individuais
        if (has_post_thumbnail()) {
            $thumbnail = wp_get_attachment_image_src(get_post_thumbnail_id(), 'large');
            echo '<meta property="og:image" content="' . $thumbnail[0] . '">' . "\n";
        }
    }
}
add_action('wp_head', 'autobolt_meta_tags');

// AJAX para formulários (exemplo básico)
function autobolt_handle_contact_form() {
    // Verificar nonce
    if (!wp_verify_nonce($_POST['nonce'], 'autobolt_nonce')) {
        wp_die('Erro de segurança');
    }
    
    // Processar dados do formulário
    $name = sanitize_text_field($_POST['name']);
    $email = sanitize_email($_POST['email']);
    $message = sanitize_textarea_field($_POST['message']);
    
    // Enviar email ou salvar no banco
    $to = get_option('admin_email');
    $subject = 'Novo contato do site Autobolt';
    $body = "Nome: $name\nEmail: $email\nMensagem: $message";
    
    if (wp_mail($to, $subject, $body)) {
        wp_send_json_success('Mensagem enviada com sucesso!');
    } else {
        wp_send_json_error('Erro ao enviar mensagem');
    }
}
add_action('wp_ajax_autobolt_contact', 'autobolt_handle_contact_form');
add_action('wp_ajax_nopriv_autobolt_contact', 'autobolt_handle_contact_form');

// Customizer (painel de personalização)
function autobolt_customize_register($wp_customize) {
    // Seção para configurações do Autobolt
    $wp_customize->add_section('autobolt_settings', array(
        'title' => 'Configurações Autobolt',
        'priority' => 120,
    ));
    
    // Número do WhatsApp
    $wp_customize->add_setting('autobolt_whatsapp', array(
        'default' => '5511999999999',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('autobolt_whatsapp', array(
        'label' => 'Número do WhatsApp',
        'section' => 'autobolt_settings',
        'type' => 'text',
    ));
    
    // Texto do botão
    $wp_customize->add_setting('autobolt_cta_text', array(
        'default' => 'QUERO AGORA!',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('autobolt_cta_text', array(
        'label' => 'Texto do Botão CTA',
        'section' => 'autobolt_settings',
        'type' => 'text',
    ));
}
add_action('customize_register', 'autobolt_customize_register');

// Função para otimização básica de performance
function autobolt_optimize_performance() {
    // Remover query strings de arquivos estáticos
    function remove_script_version($src) {
        return remove_query_arg('ver', $src);
    }
    add_filter('script_loader_src', 'remove_script_version', 15, 1);
    add_filter('style_loader_src', 'remove_script_version', 15, 1);
    
    // Desabilitar emojis se não necessário
    remove_action('wp_head', 'print_emoji_detection_script', 7);
    remove_action('wp_print_styles', 'print_emoji_styles');
}
add_action('init', 'autobolt_optimize_performance');

?>